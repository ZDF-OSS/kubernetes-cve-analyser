import subprocess
import logging
from typing import List


def get_cluster_name() -> str:
    result = subprocess.run(
        ["kubectl", "config", "current-context"],
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        text=True
    )
    if result.returncode != 0:
        logging.error(f"Error getting cluster name: {result.stderr}")
        return "unknown_cluster"
    return result.stdout.strip().split("/")[1]


def get_all_images() -> List[str]:
    result = subprocess.run(
        ["kubectl", "get", "pods", "--all-namespaces",
            "-o", "jsonpath={..image}"],
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        text=True
    )
    if result.returncode != 0:
        logging.error(f"Error getting images: {result.stderr}")
    images = result.stdout.split()
    return sorted(set(images))


def filter_images(images: List[str], substrings: List[str]) -> List[str]:
    return [image for image in images if not any(substring in image for substring in substrings)]


def check_trivy_installed() -> bool:
    result = subprocess.run(
        ["trivy", "--version"],
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        text=True
    )
    return result.returncode == 0
