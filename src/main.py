import os
import csv
import logging
from datetime import datetime
from colorama import Fore
from utils import get_cluster_name, check_trivy_installed, get_all_distinct_images
from scan import scan_image, image_report
from report import save_to_summary_csv, generate_html_summary

# Set up logging
logging.basicConfig(filename='scan.log', level=logging.INFO,
                    format='%(asctime)s:%(levelname)s:%(message)s')


def prompt_user(cluster_name):
    print(f"\nCluster Name: {cluster_name}")
    response = input(
        "Do you want to scan the current cluster content? (yes/no): ").strip().lower()
    return response == 'yes'


def main() -> None:
    print(f"{Fore.CYAN}Kubernetes CVE Scanner by ZERODOTFIVE Hamburg GmbH - moin@zerodotfive.com")
    if not check_trivy_installed():
        print(f"{Fore.RED}Trivy is not installed or not found in PATH. Please install Trivy to proceed.{Fore.RESET}")
        return

    cluster_name = get_cluster_name()

    if not prompt_user(cluster_name):
        print("Scan aborted.")
        return

    print("Starting scan... check scan.log for any issues.")
    images = get_all_distinct_images()

    os.makedirs(f"reports/{cluster_name}", exist_ok=True)

    # Generate timestamp
    timestamp = datetime.now().strftime("%Y%m%d-%H%M")

    # Prefix files with date, time, and cluster name
    summary_csv_file = f"reports/{cluster_name}/{timestamp}_{cluster_name}_scan_results_summary.csv"
    error_log_file = f"reports/{cluster_name}/{timestamp}_{cluster_name}_scan_errors.log"
    skip_list_file = f"reports/{cluster_name}/{timestamp}_{cluster_name}_skiplist.txt"
    html_report_file = f"reports/{cluster_name}/{timestamp}_{cluster_name}_scan_report.html"

    summaries = []

    with open(summary_csv_file, mode='w', newline='') as summary_file, \
            open(error_log_file, mode='w') as error_log, \
            open(skip_list_file, mode='w') as skip_list:

        summary_fieldnames = ["Image", "Total",
                              "High", "Critical", "Medium", "Low"]
        summary_csv_writer = csv.DictWriter(
            summary_file, fieldnames=summary_fieldnames)
        summary_csv_writer.writeheader()

        for image in images:

            if image.startswith("sha256"):
                skip_list.write(f"Skipped image: {image}\n")
                logging.info(f"Skipped image: {image}")
                continue

            try:
                logging.info(f"Scanning image: {image}")
                image_report(image, cluster_name)
                scan_result, error_message = scan_image(image)

                if len(scan_result['Results']) > 0:
                    all_vulnerabilities = []
                    for result in scan_result['Results']:
                        vulnerabilities = result.get('Vulnerabilities', [])
                        all_vulnerabilities.extend(vulnerabilities)

                    summary = {
                        'image': f"image:{image}",
                        'total': len(all_vulnerabilities),
                        'high': len([v for v in all_vulnerabilities if v['Severity'].upper() == 'HIGH']),
                        'critical': len([v for v in all_vulnerabilities if v['Severity'].upper() == 'CRITICAL']),
                        'medium': len([v for v in all_vulnerabilities if v['Severity'].upper() == 'MEDIUM']),
                        'low': len([v for v in all_vulnerabilities if v['Severity'].upper() == 'LOW']),
                    }
                    save_to_summary_csv(
                        f"{image}", summary, summary_csv_writer)
                    summaries.append(summary)

                    print(f"{Fore.CYAN}Summary for image: {image}: {Fore.RESET}Total: {summary['total']}, "
                          f"{Fore.LIGHTRED_EX}High: {summary['high']}, "
                          f"{Fore.RED}Critical: {summary['critical']}, "
                          f"{Fore.YELLOW}Medium: {summary['medium']}, "
                          f"{Fore.GREEN}Low: {summary['low']}")
                    logging.info(f"Summary for image: {image}: Total: {summary['total']}, High: {summary['high']}, "
                                 f"Critical: {summary['critical']}, Medium: {summary['medium']}, Low: {summary['low']}")
                else:
                    print(f"Scanning {image} errr")
                    error_message = f"Failed to scan image: {image}\n{error_message}\n"
                    logging.error(error_message)
                    error_log.write(error_message)
            except Exception as e:
                error_message = f"Exception occurred while scanning image: {image}\n{str(e)}\n"
                print(e)
                error_log.write(error_message)

    generate_html_summary(summaries, html_report_file, cluster_name, timestamp)


if __name__ == "__main__":
    main()
